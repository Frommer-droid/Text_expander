# Руководство разработчика (DEVELOPER.md)

## 1. Обзор проекта

**Text Expander** — это приложение для автоматической замены текста (сниппетов) с графическим интерфейсом на базе **PySide6**. Программа отслеживает ввод с клавиатуры (используя `pynput`) и автоматически заменяет заданные аббревиатуры на полный текст.

### Основные возможности:
- Управление сниппетами (создание, редактирование, удаление).
- Аббревиатуры на основе скан-кодов клавиатуры (независимо от раскладки).
- **`logo.ico`**: Иконка приложения.

## 2. Структура проекта

- **`Text_expander.pyw`** — тонкая точка входа (инициализация и запуск).
- **`app/core/`** — бизнес-логика и оркестрация (при необходимости расширения).
- **`app/ui/`** — интерфейс и логика GUI.
- **`app/services/`** — сервисы (слушатель клавиатуры, WinAPI, пути, логирование).
- **`app/utils/`** — общие утилиты и вспомогательные функции.
- **`app/version.py`** — источник версии для GUI и сборки.
- **`VERSION`** — номер версии в dev-режиме.

## 3. Требования к окружению

Для разработки и запуска требуются **Python 3.x** и следующие библиотеки:

- `PySide6` — графический интерфейс.
- `pynput` — перехват нажатий клавиатуры.
- `pywin32` — взаимодействие с Windows API (определение активного окна, работа с буфером обмена и треем).
- `psutil` — получение информации о процессах.
- `pyperclip` — работа с буфером обмена (кроссплатформенная обертка).

### Установка зависимостей:

```bash
pip install PySide6 pynput pywin32 psutil pyperclip
```

## 4. Запуск и отладка

Для запуска приложения из исходного кода выполните команду:

```bash
python Text_expander.pyw
```

> **Примечание:** Для корректной работы функций автозамены и перехвата клавиш в некоторых приложениях (и для записи в автозагрузку) может потребоваться запуск **от имени администратора**. Скрипт автоматически пытается перезапустить себя с повышенными правами, если это необходимо.

## 5. Сборка приложения (PyInstaller)

Приложение подготовлено для сборки в единый исполняемый файл (`.exe`) с помощью **PyInstaller**. В коде присутствует функция `resource_path`, обеспечивающая корректный доступ к ресурсам как в режиме разработки, так и в собранном виде (пути вычисляются относительно `sys.executable`).

Пример команды для сборки:

```bash
pyinstaller --noconsole --onefile --icon=logo.ico --name="Text_expander" --add-data "logo.ico;." Text_expander.pyw
```

## 6. Архитектура и ключевые классы

### `TextExpanderApp` (QMainWindow) — `app/ui/main_window.py`
Главный класс приложения. Отвечает за:
- Инициализацию GUI (вкладки, дерево сниппетов, редактор).
- Загрузку и сохранение настроек и сниппетов.
- Обработку событий трея и автозапуска.
- Управление потоком слушателя.

### `ListenerWorker` — `app/services/listener_worker.py`
Класс, работающий в отдельном потоке (`threading.Thread`).
- Инициализирует `pynput.keyboard.Listener`.
- Отслеживает нажатия клавиш и формирует буфер скан-кодов.
- Проверяет буфер на наличие аббревиатур.
- Выполняет замену текста (эмуляция через WinAPI SendInput и вставка через буфер обмена).
- Содержит специальную логику для `winword.exe` (Microsoft Word).

### `app/services/scan_code_keyboard.py`
Модуль для работы со скан-кодами клавиатуры.
- Преобразует аббревиатуры в последовательности скан-кодов.
- Формирует индекс сниппетов по скан-кодам.
- Отправляет ввод через WinAPI `SendInput`.

### `SnippetTreeWidget` (QTreeWidget) — `app/ui/snippet_tree_widget.py`
Кастомизированный виджет дерева.
- Реализует логику Drag-and-Drop для перемещения сниппетов и категорий.
- Обрабатывает сигналы перемещения элементов.

## 7. Правила разработки (Code Style)

- **Язык**: Весь код, комментарии и документация должны быть на **русском языке** (согласно глобальным правилам Antigravity IDE).
- **Форматирование**: Соблюдение стандартов PEP8.
- **Версионирование**: При релизе обновляйте `VERSION` (dev), `app/version.py` (FROZEN_VERSION для .exe) и `RELEASE_NOTES.md`.
